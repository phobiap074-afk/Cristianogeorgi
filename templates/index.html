<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Crompton Dealer Reward Program Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* --- Mobile-friendly CSS (no backend-facing changes) --- */
    :root {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --primary: #6b79ff;
      --bg: #f7f7fb;
      --text: #222;
      --muted: #666;
      --border: #ddd;
      --radius: 16px;
    }

    html { font-size: 16px; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--bg); color: var(--text); }

    .container {
      width: min(100% - 32px, 720px);
      margin: 24px auto;
      padding: 16px;
      background: #fff;
      border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
      text-align: center;
    }
    @media (min-width: 600px) {
      .container { margin: 48px auto; padding: 24px; }
    }

    .logo { margin-bottom: 24px; }
    .logo img { height: clamp(48px, 10vw, 80px); width: auto; }

    .row { display: grid; grid-template-columns: 1fr; gap: 12px; text-align: left; }
    label { font-size: 0.875rem; color: #333; }

    input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 16px; /* prevents iOS zoom on focus */
      background: #fff;
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease;
      -webkit-appearance: none;
      appearance: none;
    }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(107,121,255,0.15); }
    input[readonly] { background: #f2f3f8; color: #222; }

    .actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap; /* allow wrap on small screens */
    }

    button {
      border: 0;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      background: var(--primary);
      color: #fff;
      line-height: 1;
      min-height: 44px; /* touch target */
      min-width: 44px;
      transition: transform .05s ease, filter .15s ease;
    }
    button:hover { filter: brightness(0.98); }
    button:active { transform: translateY(1px); }
    button.secondary { background: #e5e7ef; color: #222; }

    /* General two-column grid: stack on mobile, split on wider screens */
    .grid-2 { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 520px) {
      .grid-2 { grid-template-columns: 1fr 1fr; }
    }

    /* Special handling for the first .grid-2 (GSTIN + Verify) */
    .row > div:first-child .grid-2 > button { width: 100%; }
    @media (min-width: 520px) {
      .row > div:first-child .grid-2 { grid-template-columns: 1fr auto; }
      .row > div:first-child .grid-2 > button { width: auto; }
    }

    .hint { font-size: 0.8125rem; color: var(--muted); }
    .alert {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: #eef6ff;
      color: #0b3d91;
      display: none;
      text-align: center;
    }
    .alert.error { background: #ffeef0; color: #8a1027; }

    .muted { color: var(--muted); font-size: 0.875rem; text-align: center; margin-top: 16px; }
    .disabled { opacity: 0.6; pointer-events: none; }
    .small { font-size: 0.75rem; color: var(--muted); text-align: right; }

    img { max-width: 100%; height: auto; }
    code { background: #f4f5f9; padding: 2px 6px; border-radius: 6px; }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; animation: none !important; }
    }
    @supports (padding: max(0px)) {
      body { padding-bottom: env(safe-area-inset-bottom); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Crompton Logo -->
    <div class="logo">
      <img src="/static/crompton_logo.png" alt="Crompton">
    </div>

    <div class="row">
      <div>
        <label for="gstn">GSTIN</label>
        <div class="grid-2">
          <input id="gstn" maxlength="15" placeholder="Enter 15-character GSTIN (A–Z, 0–9)" autocomplete="off" />
          <button id="verifyBtn" title="Verify GSTIN via AppyFlow" type="button">Verify</button>
        </div>
        <div class="hint">Click Verify to auto-fill Legal Name &amp; Firm Name. Only verified GSTINs can be saved.</div>
        <div class="small" id="gstnCount">0 / 15</div>
      </div>

      <div>
        <label for="legalName">Legal Name (read-only)</label>
        <input id="legalName" readonly />
      </div>

      <div>
        <label for="firmName">Firm Name (read-only)</label>
        <input id="firmName" readonly />
      </div>

      <div class="grid-2">
        <div>
          <label for="name1">Primary Name</label>
          <input id="name1" placeholder="Enter first ticket holder name" autocomplete="name" />
        </div>
        <div>
          <label for="name2">Secondary Name</label>
          <input id="name2" placeholder="Enter second ticket holder name" autocomplete="nickname" />
        </div>
      </div>

      <div>
        <label for="contact">Phone</label>
        <input id="contact" type="tel" placeholder="Enter phone number" pattern="[0-9]{10}" maxlength="10" inputmode="numeric" autocomplete="tel" />
      </div>

      <div class="actions">
        <button id="saveBtn" class="disabled" title="Verify GSTIN first" type="button">Save</button>
        <button class="secondary" id="resetBtn" type="button">Reset</button>
      </div>

      <div class="alert" id="notice" role="status" aria-live="polite"></div>
    </div>

    <p class="muted">
      Legal Name = <code>taxpayerInfo.lgnm</code> &nbsp;|&nbsp;
      Firm Name = <code>taxpayerInfo.tradeNam</code>
    </p>
  </div>

  <script>
    const el = (id) => document.getElementById(id);
    const notice = el("notice");
    const gstnInput = el("gstn");
    const saveBtn = el("saveBtn");
    const verifyBtn = el("verifyBtn");
    const count = el("gstnCount");

    let verified = false;

    function show(msg, isError=false) {
      notice.textContent = msg;
      notice.classList.toggle("error", isError);
      notice.style.display = "block";
      if (!isError) setTimeout(() => (notice.style.display = "none"), 3000);
    }

    function setVerified(v) {
      verified = v;
      saveBtn.classList.toggle("disabled", !verified);
      saveBtn.title = verified ? "" : "Verify GSTIN first";
    }

    function resetForm() {
      gstnInput.value = "";
      el("legalName").value = "";
      el("firmName").value = "";
      el("name1").value = "";
      el("name2").value = "";
      el("contact").value = "";
      count.textContent = "0 / 15";
      setVerified(false);
      notice.style.display = "none";
    }

    el("resetBtn").addEventListener("click", resetForm);

    gstnInput.addEventListener("input", () => {
      let v = gstnInput.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
      if (v.length > 15) v = v.slice(0, 15);
      if (v !== gstnInput.value) gstnInput.value = v;
      count.textContent = `${gstnInput.value.length} / 15`;
      el("legalName").value = "";
      el("firmName").value = "";
      setVerified(false);
    });

    function isValidGSTIN(s) {
      return /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z][A-Z0-9]Z[A-Z0-9]$/.test(s);
    }

    verifyBtn.addEventListener("click", async () => {
      const gstn = gstnInput.value.trim();
      if (gstn.length !== 15) return show("GSTIN must be exactly 15 characters.", true);
      if (!isValidGSTIN(gstn)) return show("GSTIN format looks invalid.", true);

      try {
        const r = await fetch("/api/verify_gst", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gstn }),
        });
        const data = await r.json();

        if (!data.ok) {
          el("legalName").value = "";
          el("firmName").value = "";
          setVerified(false);
          return show(data.message || "Verification failed.", true);
        }

        el("legalName").value = data.legal_name || "";
        el("firmName").value = data.firm_name || "";
        setVerified(true);
        show("GSTIN verified and names filled.");
      } catch (e) {
        setVerified(false);
        show("Network error verifying GSTIN.", true);
      }
    });

    saveBtn.addEventListener("click", async () => {
      if (!verified) return show("Please verify GSTIN successfully before saving.", true);

      const payload = {
        gstn: gstnInput.value.trim(),
        legal_name: el("legalName").value.trim(),
        firm_name: el("firmName").value.trim(),
        name1: el("name1").value.trim(),
        name2: el("name2").value.trim(),
        contact: el("contact").value.trim(),
      };

      if (!payload.gstn || !payload.legal_name || !payload.firm_name || !payload.name1 || !payload.contact) {
        return show("Please verify GSTIN and fill required fields (Dealer Name, Phone).", true);
      }

      try {
        const r = await fetch("/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await r.json();

        if (!data.ok) {
          if (r.status === 409 || data.code === "duplicate") {
            return show("This GSTIN already exists in the system.", true);
          }
          return show(data.message || "Save failed.", true);
        }

        show("Saved successfully!");
        setTimeout(() => resetForm(), 1500);
      } catch (e) {
        show("Network error saving record.", true);
      }
    });
  </script>
</body>
</html>
